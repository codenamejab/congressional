<!DOCTYPE html>
<html>
<head>
<style>
div.a {
    text-align: center;
}
</style>
</head>
<body>

<div class = "a" id = "myDIV">
<h1 id="TB" style = "color:black;">Hit the target!</h1>
<h2 style = "color:black;">Using the input box below, write the equation of the target in (x - h)^2 + (y - k)^2 = r^2 form</h2>
<!-- <h3 id="nums"></h3> -->
<h3 id = "nums"></h3>
<br>

<input type="text" id="ans"> </input>
<button onclick="checkAns()" id="btn"> Check </button>

<br>
<br>
<br>
<br>

<canvas id = "myCanvas" width = "600" height = "600" style = "border:1px solid #d3d3d3;">
</canvas>
<img id = "targetpic" src = "archerygame/assets/target.png" style = "display: none;">
<!-- <img id = "arrowpic" src = "archerygame/assets/arrow.png" style = "display: none"> -->
<script>
var target = document.getElementById("targetpic");
arrow = new Image();
arrow.src = 'archerygame/assets/arrow.png';
var canvas = document.getElementById("myCanvas");
var ctx = canvas.getContext("2d");
ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
var centerx = Math.floor(Math.random() * 17) - 8;
while(centerx == 0 || centerx == 7 || centerx == 8 || centerx == 9) {
    centerx = Math.floor(Math.random() * 17) - 8;
}
var centery = Math.floor(Math.random() * 17) - 8;
while(centery == 0 || centery == 7 || centery == 8 || centery == 9) {
    centery = Math.floor(Math.random() * 17) - 8;
}
var radius = 0;
calculateRadius();
drawTarget();
drawGraph();

function calculateRadius() {
    var possibles = [60, 120, 180, 240, 300, 360, 420];
    var restrict = 10 - Math.max(Math.abs(centerx), Math.abs(centery));
    if(restrict >= 7) var randindex = Math.floor(Math.random() * 7);
    else var randindex = Math.floor(Math.random() * restrict);
    radius = possibles[randindex];
    document.getElementById("nums").innerHTML = centerx + " " + centery + " " + (radius / 60);
}

function drawTarget() {
    ctx.drawImage(target, (centerx + 10) * 30 - (radius / 2) - (radius / 30), -30 * centery + 300 - (radius / 2) - (radius / 30), radius + (radius / 30) * 2, radius + (radius / 30) * 2);
    //ctx.drawImage(target, 0, 0, 100, 100);
    //ctx.drawImage(arrow, 0, 0, 100, 100);
}

//ctx.drawImage(arrow, 0, 0, 10, 10);

function drawGraph() {
    //vert lines
    for(var i = 1; i <= 21; i++) {
        ctx.lineWidth = 0.5;
        if(i == 10) ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(i * 30, 0);
        ctx.lineTo(i * 30, 600);
        ctx.stroke();
    }

    //horz lines
    for(var i = 1; i <= 21; i++) {
        ctx.lineWidth = 0.5;
        if(i == 10) ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(0, i * 30);
        ctx.lineTo(600, i * 30);
        ctx.stroke();
    }
    //ctx.beginPath();
    //ctx.rect(500, 0, 100, 100);
    //ctx.stroke();
}

function checkAns() {
    var text = document.getElementById("ans").value;
    try {
        if(!text.includes("y")) {
            throw "No \"y\" detected!"
        }
        if(!text.includes("=")) {
            throw "No equal sign detected!"
        }
        if(!text.includes("x")) {
            throw "No \"x\" sign detected!"
        }
    } catch(e) {
        alert("ERROR = " + e)
        return
    }
    var h = 0;
    var k = 0;
    var r = 0;
    var newstr = "";
    for(var i = 0; i < text.length; i++) {
        if(text.charAt(i) != ' ') newstr+=text.charAt(i);
    }
    //document.getElementById("nums").innerHTML = newstrnospace;
    //document.getElementById("nums").innerHTML = newstr;
    try {
        if(newstr.substring(0, 2) != '(x') {
            throw "invalid syntax!x"
        }
        //( x + 8 ) ^ 2 + ( y - 9 ) ^ 2 = 4 9
        //0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7
        //x ^ 2 + y ^ 2 = 9
        if(newstr.substring(4, 10) != ')^2+(y') {
            throw "invalid syntax!y"
        }
        if(newstr.substring(12, 16) != ')^2=') {
            throw "invalid syntax!end"
        }
        if(newstr.substring(newstr.length - 2, newstr.length) == '^2') {
            throw "simplify your radius!"
        }
    } catch(e) {
        alert("ERROR  = " + e)
        return
    }
    h = parseInt(newstr.substring(2, 4)) * -1;
    k = parseInt(newstr.substring(10, 12)) * -1;
    r = Math.sqrt(parseInt(newstr.substring(16, newstr.length)));
    //document.getElementById("nums").innerHTML = h + " " + centerx + " " + k + " " + centery + " " + r + " " + (radius/30);

    if(h == centerx && k == centery && r == radius / 60) {
        animate();
    } else {
        alert("Incorrect! Please try again!")
        return
    }
    var arrowx = 495;
    var arrowy = 5;
    function animate() {
        animate = setInterval(function() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.lineWidth = 5;

            ctx.strokeStyle = 'black';
            drawTarget();
            drawGraph();
            ctx.drawImage(arrow, arrowx, arrowy, 100, 100);
            if(arrowx <= (centerx + 10) * 30 - 100 || arrowy >= -30 * centery + 300 - 100) {
                endanimate();
                return;
            }
            arrowx-=(400-((centerx + 10) * 30 - 100))/100;
            arrowy+=(-30 * centery + 300 - 100)/100;
        }, 10);
    }
    function endanimate() {
        clearInterval(animate);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.lineWidth = 5;

        ctx.strokeStyle = 'black';
        drawTarget();
        drawGraph();
        ctx.drawImage(arrow, centerx, centery - 95, 100, 100);
        alert("Correct! Refresh the page for a new question")
    }

    /*
    var fps = 60;
    var percent = 0;
    var direction = 1;

    function animate() {

        // set the animation position (0-100)
        percent += direction;
        if (percent < 0) {
            percent = 0;
            direction = 1;
        };
        draw(percent);

        if (percent < 100) {
            // request another frame
            setTimeout(function () {
                requestAnimationFrame(animate);
            }, 1000 / fps);
        }
    }
    */

    // draw the current frame based on sliderValue
    function draw(sliderValue) {

        // redraw path
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.lineWidth = 5;

        ctx.strokeStyle = 'black';
        drawTarget();
        drawGraph();
        /*
        ctx.beginPath();
        ctx.moveTo(600, 0);
        ctx.lineTo((centerx + 10) * 30, -30 * centery + 300);
        ctx.strokeStyle = "red";
        ctx.stroke();
        */
        var xy;
        var percent = sliderValue / 100;
        xy = getLineXYatPercent({
            x:600,
            y:0
        }, {
            x:(centerx + 10) * 30,
            y:-30 * centery + 300
        }, percent);
        drawRect(xy, "red");
    }

    // draw tracking rect at xy
    function drawRect(point, color) {
        //ctx.fillStyle = "cyan";
        //ctx.strokeStyle = "gray";
        //ctx.lineWidth = 3;  
        //ctx.beginPath();
        //                                       mess around with numbers
        ctx.drawImage(arrow, point.x - 100, point.y - 100, 100, 100);
        //console.log("Printed!");
        //ctx.rect(point.x - 13, point.y - 8, 20, 20);
        //ctx.fill();
        //ctx.stroke();
    }

    //draw tracking dot at xy
    function drawDot(point,color){
        ctx.fillStyle=color;
        ctx.strokeStyle="black";
        ctx.lineWidth=3;
        ctx.beginPath();
        ctx.arc(point.x,point.y,8,0,Math.PI*2,false);
        ctx.closePath();
        ctx.fill();
        ctx.stroke();
    }

    // quadratic bezier: percent is 0-1
    // line: percent is 0-1
    function getLineXYatPercent(startPt,endPt,percent) {
        var dx = endPt.x-startPt.x;
        var dy = endPt.y-startPt.y;
        var X = startPt.x + dx*percent;
        var Y = startPt.y + dy*percent;
        return({
            x:X,
            y:Y
        });
    }
}

</script>
<br>
<br>

<button type = "button" onclick = "refresh()" id = "newq"> New Question </button>
<script>
function refresh() {
    location.reload();
    return false;
}
</script>

</div>

</body>
</html>
